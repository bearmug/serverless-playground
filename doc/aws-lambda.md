- [Serverless setup playground](#lambdas-playground)
  * [Pre-requisites](#pre-requisites)
    + [Code deployment pipeline](#code-deployment-pipeline)
    + [AWS account](#aws-account)
    + [AWS role](#aws-role)
  * [AWS Deployment](#aws-deployment)
  * [Performance validation](#performance-validation)
    + [Performance samples](#performance-samples)
      - [Client-side measurements](#client-side-measurements)
      - [AWS-side measurements](#aws-side-measurements)
  * [Logs and stats review](#logs-and-stats-review)

# AWS Lambdas playground
This part is an experiment with serverless approach variances. Right now it includes cases like:
* **micronaut-java8 setup**
     [Micronaut](https://micronaut.io/) -based lambda, running with java8 [existing AWS runtime](https://micronaut-projects.github.io/micronaut-aws/latest/guide/#lambda)
     and includes lambda function plus API gateway instance. Simple, but really slow on cold starts. Here is a
     [link](https://micronaut-projects.github.io/micronaut-aws/latest/guide/#apiProxy) with an instruction how to generate 
     lambda from the scratch with micronaut tooling.
* **micronaut-graalvm setup**
    Micronaut-based lambda with [GraalVM](https://www.graalvm.org/docs/why-graal/) custom runtime. Cold start issue mitigated, 
    warm call timings similar to **java8**. [Here is Micronaut-based](https://micronaut-projects.github.io/micronaut-aws/latest/guide/#_custom_graalvm_native_runtimes)
    build instruction.
* **serverless-nodejs setup**
    Nodejs-based lambda. [Autogenerated](https://serverless.com/framework/docs/providers/aws/cli-reference/create/) with 
    serverless framework. Used as a performance reference for load-test benchmark.

## Pre-requisites
### Code deployment pipeline
[Serverless](https://serverless.com/) framework has been chosen as a cloud delivery vehicle. Please see 
[get-started](https://serverless.com/framework/docs/getting-started/) guide for setup details (few steps actually).

### AWS account
Experimentation implemented with AWS platform. There is an assumption that you have AWS account. Just in case, 
[here](https://aws.amazon.com/ru/premiumsupport/knowledge-center/create-and-activate-aws-account/) is AWS manual about it.

### AWS role
Serverless framework needs a set of permissions in order to deploy application stack. You may find full permissions list 
into attached [policy](../config/serverless/deployment-policy.json). This one has to be linked to AWS user. Remember to provide Serverless
with AWS user configuration, the simplest approach is to export keys variables:
```bash
export AWS_ACCESS_KEY_ID=<your access key here>
export AWS_SECRET_ACCESS_KEY=<your secret key>
```

## AWS Deployment
```bash
./gradlew awsLambdaDeploy # build artefacts and run deployment
./gradlew awsLambdaDeploy --dry-run # see the whole tasks dependency tree with this command
./gradlew awsLambdaRemove # remove all components from AWS
```

## Performance validation
Load test runs [simplified scenario](../config/load-test/load-test-simple.js) by default, which likeli fits to lambda [free
usage tier](https://aws.amazon.com/ru/lambda/pricing/). Otherwise, feel free to use alternative 
[scenario](../config/load-test/load-test-ramping.js). Default load test configuration could be triggered like:
```bash
./gradlew loadTest -PurlArg=https://xxx.execute-api.eu-west-1.amazonaws.com/playground/ping/graal
./gradlew loadTest -PurlArg=https://xxx.execute-api.eu-west-1.amazonaws.com/playground/ping/jvm
```
You can find URLs to test from serverless deployment command or from service info printout:
```bash
serverless info
```

AWS-side timings captured from CloudWatch Insights with query:
```bash
fields @timestamp, @duration, @billedDuration
| filter ispresent(@duration)
| stats count(),                # calls total number
        sum(@billedDuration),   # billed time, total
        sum(@duration),         # call time sum, total
        pct(@duration, 50),     # 50%-ile for calls timings
        pct(@duration, 90),     # 90%-ile
        pct(@duration, 95),     # 95%-ile 
        max(@duration),         # max
        min(@duration)          # min
by bin(5m)
```

### Performance samples
Test [scenario](../config/load-test/load-test-simple.js) with single virtual user and permanent load gives numbers below
#### Client-side measurements
|               | min,ms | 50%-ile,ms | 90%-ile,ms | 95%-ile,ms | max,ms  | calls |
|---------------|--------|------------|------------|------------|---------|-------|
| java8, cold   | 56.56  | 70.8       | 279.05     | 349.07     | 4950    | 39    |
| graal, cold   | 57.14  | 62.5       | 204.52     | 252.51     | 998.09  | 95    |
| nodejs, cold  | 57.02  | 75.71      | 201.34     | 291.19     | 716.07  | 91    |
| java8, warm   | 57.25  | 63.41      | 159.42     | 247.9      | 452.69  | 109   |
| graal, warm   | 56.39  | 62.26      | 155.06     | 251.52     | 376.91  | 114   |
| nodejs, warm  | 58.19  | 72.23      | 198.28     | 297.4      | 462.47  | 94    |

#### AWS-side measurements
|              | min,ms | 50%-ile,ms | 90%-ile,ms | 95%-ile,ms | max,ms  | init,ms | calls | billed,ms | billed/call,ms |
|--------------|--------|------------|------------|------------|---------|---------|-------|-----------|----------------|
| java8, cold  | 2.04   | 2.31       | 18.54      | 36.57      | 2116.96 | 2386.16 | 40    | 6300      | 157.5          |
| graal, cold  | 1.55   | 1.81       | 14.99      | 29.81      | 183.99  | 303.24  | 96    | 10200     | 106.25         |
| nodejs, cold | 2.15   | 3.8        | 18.35      | 35.21      | 98.15   | 214.60  | 92    | 9200      | 100            |
| java8, warm  | 1.94   | 2.12       | 2.52       | 18.21      | 239.55  | 0       | 110   | 11200     | 101.8          |
| graal, warm  | 1.51   | 1.72       | 6.45       | 12.26      | 16.68   | 0       | 115   | 11500     | 100            |
| nodejs, warm | 2.21   | 3.28       | 22.02      | 40.32      | 89.15   | 0       | 95    | 9500      | 100            |


## Logs and stats review
```bash
./gradlew awsLambdaStatsGraal # request logs and stats from Cloud Watch and see them into console
./gradlew awsLambdaStatsJava #
...
./gradlew sSG
./gradlew sSJ
```
