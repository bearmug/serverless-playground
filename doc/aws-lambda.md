- [Serverless setup playground](#lambdas-playground)
  * [Pre-requisites](#pre-requisites)
    + [Code deployment pipeline](#code-deployment-pipeline)
    + [AWS account](#aws-account)
    + [AWS role](#aws-role)
  * [AWS Deployment](#aws-deployment)
  * [Performance validation](#performance-validation)
    + [Performance samples](#performance-samples)
      - [Client-side measurements](#client-side-measurements)
      - [AWS-side measurements](#aws-side-measurements)
  * [Logs and stats review](#logs-and-stats-review)

# AWS Lambdas playground
This part is an experiment with serverless approach variances. Right now it includes cases like:
* **micronaut-java8 setup**
     [Micronaut](https://micronaut.io/) -based lambda, running with java8 [existing AWS runtime](https://micronaut-projects.github.io/micronaut-aws/latest/guide/#lambda)
     and includes lambda function plus API gateway instance. Simple, but really slow on cold starts. Here is a
     [link](https://micronaut-projects.github.io/micronaut-aws/latest/guide/#apiProxy) with an instruction how to generate 
     lambda from the scratch with micronaut tooling.
* **micronaut-graalvm setup**
    Micronaut-based lambda with [GraalVM](https://www.graalvm.org/docs/why-graal/) custom runtime. Cold start issue mitigated, 
    warm call timings similar to **java8**. [Here is Micronaut-based](https://micronaut-projects.github.io/micronaut-aws/latest/guide/#_custom_graalvm_native_runtimes)
    build instruction.
* **serverless-nodejs setup**
    Nodejs-based lambda. [Autogenerated](https://serverless.com/framework/docs/providers/aws/cli-reference/create/) with 
    serverless framework. Used as a performance reference for load-test benchmark.

## Pre-requisites
### Code deployment pipeline
[Serverless](https://serverless.com/) framework has been chosen as a cloud delivery vehicle. Please see 
[get-started](https://serverless.com/framework/docs/getting-started/) guide for setup details (few steps actually).

### AWS account
Experimentation implemented with AWS platform. There is an assumption that you have AWS account. Just in case, 
[here](https://aws.amazon.com/ru/premiumsupport/knowledge-center/create-and-activate-aws-account/) is AWS manual about it.

### AWS role
Serverless framework needs a set of permissions in order to deploy application stack. You may find full permissions list 
into attached [policy](../config/serverless/deployment-policy.json). This one has to be linked to AWS user. Remember to provide Serverless
with AWS user configuration, the simplest approach is to export keys variables:
```bash
export AWS_ACCESS_KEY_ID=<your access key here>
export AWS_SECRET_ACCESS_KEY=<your secret key>
```

## AWS Deployment
```bash
./gradlew awsLambdaDeploy # build artefacts and run deployment
./gradlew awsLambdaDeploy --dry-run # see the whole tasks dependency tree with this command
./gradlew awsLambdaRemove # remove all components from AWS
```

## Performance validation
Load test runs [simplified scenario](../config/load-test/load-test-simple.js) by default, which likeli fits to lambda [free
usage tier](https://aws.amazon.com/ru/lambda/pricing/). Otherwise, feel free to use alternative 
[scenario](../config/load-test/load-test-ramping.js). Default load test configuration could be triggered like:
```bash
./gradlew loadTest -PurlArg=https://xxx.execute-api.eu-west-1.amazonaws.com/playground/ping/graal
./gradlew loadTest -PurlArg=https://xxx.execute-api.eu-west-1.amazonaws.com/playground/ping/jvm
```
You can find URLs to test from serverless deployment command or from service info printout:
```bash
serverless info
```

AWS-side timings captured from CloudWatch Insights with query:
```bash
fields @timestamp, @duration, @billedDuration
| filter ispresent(@duration)
| stats count(),                # calls total number
        sum(@billedDuration),   # billed time, total
        sum(@duration),         # call time sum, total
        pct(@duration, 50),     # 50%-ile for calls timings
        pct(@duration, 90),     # 90%-ile
        pct(@duration, 95),     # 95%-ile 
        pct(@duration, 99),     # 99%-ile 
        max(@duration),         # max
        min(@duration)          # min
```

AWS query to calculate average init duration:
```bash
parse @message "Init Duration: * ms" as @initduration
| filter ispresent(@initduration)
| stats count(),           # calls total number
        avg(@initduration) # avg init duration
```

### Performance samples
Test [scenario](../config/load-test/load-test-simple.js) with single virtual user and permanent load gives numbers below
#### Client-side measurements
|                     | min,ms | 50%-ile,ms | 90%-ile,ms | 95%-ile,ms | 99%-ile,ms | max,ms  | calls |
|---------------------|--------|------------|------------|------------|------------|---------|-------|
| java8, cold         | 61.45  | 159.37     | 194.84     | 2420       | 6720       | 7630    | 15    |
| java8-native, cold  | 57.22  | 61.5       | 183.71     | 193.05     | 317.93     | 807.31  | 114   |
| kotlin, cold        | 61.47  | 183.67     | 198.71     | 243 0      | 6590       | 7640    | 15    |
| kotlin-native, cold | 56.83  | 62.01      | 168.55     | 210.34     | 312.41     | 823     | 111   |
| nodejs, cold        | 56.88  | 61.8       | 147.56     | 191.68     | 246.59     | 406.32  | 116   |
| java8, warm         | 55.6   | 60.42      | 143.52     | 202.05     | 402.47     | 493.33  | 123   |
| java8-native, warm  | 56.33  | 60.27      | 84.49      | 188.46     | 253.71     | 327.64  | 132   |
| kotlin, warm        | 56.31  | 60.51      | 153.84     | 191.96     | 326.34     | 376.02  | 122   |
| kotlin-native, warm | 56.41  | 61.69      | 142.71     | 165.77     | 233.56     | 276.32  | 129   |
| nodejs, warm        | 55.89  | 60.97      | 148.85     | 197.83     | 443.78     | 484.94  | 119   |

#### AWS-side measurements
|                     | min,ms | 50%-ile,ms | 90%-ile,ms | 95%-ile,ms | 99%-ile,ms | max,ms  | init, avg ms | calls | billed,ms | billed/call,ms |
|---------------------|--------|------------|------------|------------|------------|---------|--------------|-------|-----------|----------------|
| java8, cold         | 2.0    | 2.17       | 233.67     | 4471.92    | 4695.03    | 4739.86 | 2554.31      | 164   | 63300     | 385.97         |
| java-native, cold   | 1.47   | 1.719      | 2.1784     | 28.9716    | 170.62     | 180.51  | 338.84       | 1125  | 119000    | 105.77         |
| kotlin, cold        | 1.98   | 2.15       | 202.3      | 4430.62    | 4674.97    | 4889.21 | 2637.84      | 159   | 62100     | 390.56         |
| kotlin-native, cold | 1.55   | 1.7087     | 2.1784     | 20.1963    | 171.3021   | 181.46  | 331.27       | 1110  | 117400    | 105.76         |
| nodejs, cold        | 0.84   | 1.03       | 1.23       | 1.35       | 2.78       | 17.11   | 165.22       | 1141  | 114100    | 100            |
| java8, warm         | 1.23   | 1.42       | 1.87       | 2.14       | 19.15      | 290.41  | 0            | 1202  | 120400    | 100.16         |
| java8-native, warm  | 1.43   | 1.61       | 1.83       | 1.94       | 21.22      | 178.85  | 0            | 1176  | 117900    | 100.25         |
| kotlin, warm        | 1.23   | 1.45       | 1.93       | 2.25       | 17.91      | 217.27  | 0            | 1156  | 115800    | 100.17         |
| kotlin-native, warm | 1.45   | 1.63       | 1.88       | 2.01       | 19.03      | 172.9   | 0            | 1209  | 121200    | 100.25         |
| nodejs, warm        | 0.79   | 0.97       | 1.17       | 1.27       | 1.59       | 26.41   | 0            | 1188  | 118800    | 100            |


## Logs and stats review
```bash
./gradlew awsLambdaStatsGraal # request logs and stats from Cloud Watch and see them into console
./gradlew awsLambdaStatsJava #
...
./gradlew sSG
./gradlew sSJ
```
